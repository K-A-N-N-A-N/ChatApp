<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial;
            max-width: 600px;
            margin: auto;
        }
        #header {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }
        #chat {
            border: 1px solid #ccc;
            height: 350px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        .me {
            font-weight: bold;
        }
        .other {
            font-weight: normal;
        }
    </style>
</head>
<body>

<div id="header"></div>
<div id="chat"></div>

<input id="message" placeholder="Type message..." style="width: 80%;" />
<button onclick="send()">Send</button>

<script>
    const params = new URLSearchParams(window.location.search);
    const chatRoomId = params.get("chatRoomId");

    if (!chatRoomId) {
        alert("Missing chatRoomId");
        throw new Error("Missing chatRoomId");
    }

    let currentUserId;
    let currentUsername;
    let stompClient;

    const chatDiv = document.getElementById("chat");

    // ================================
    //  FETCH LOGGED-IN USER
    // ================================
    fetch("/auth/me")
        .then(res => res.json())
        .then(user => {
            if (!user.userId || !user.username) {
                alert("User not logged in");
                throw new Error("Not logged in");
            }

            currentUserId = user.userId;
            currentUsername = user.username;

            document.getElementById("header").innerHTML = `
                <b>Connected as:</b> ${currentUsername}<br/>
                <b>Private Chat</b>
            `;

            loadChatHistory();
        });

    // ================================
    //  LOAD CHAT HISTORY
    // ================================
    function loadChatHistory() {
        fetch(`/chatrooms/${chatRoomId}/messages`)
            .then(res => res.json())
            .then(messages => {
                messages.forEach(body => {
                    renderMessage(body);
                });

                chatDiv.scrollTop = chatDiv.scrollHeight;
                connectWebSocket();
            })
            .catch(err => {
                console.error("Failed to load chat history", err);
                connectWebSocket();
            });
    }

    // ================================
    //  CONNECT WEBSOCKET
    // ================================
    function connectWebSocket() {
        const socket = new WebSocket(
            "ws://localhost:8080/ws?chatRoomId=" + chatRoomId
        );

        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            console.log(" WebSocket connected");

            stompClient.subscribe("/topic/chatroom/" + chatRoomId, (msg) => {
                const body = JSON.parse(msg.body);
                renderMessage(body);
            });
        });
    }

    // ================================
    //  RENDER MESSAGE
    // ================================
    function renderMessage(body) {
        const isMe = body.senderId === currentUserId;
        const senderLabel = isMe ? "You" : body.senderUsername;
        const cssClass = isMe ? "me" : "other";

        chatDiv.innerHTML +=
            `<p class="${cssClass}">${senderLabel}: ${body.content}</p>`;

        chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // ================================
    //  SEND MESSAGE
    // ================================
    function send() {
        const input = document.getElementById("message");
        if (!input.value.trim()) return;

        stompClient.send(
            "/app/chat.send",
            {},
            JSON.stringify({ content: input.value })
        );

        input.value = "";
    }
</script>

</body>
</html>
