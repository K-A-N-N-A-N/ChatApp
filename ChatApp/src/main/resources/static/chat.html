<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial;
            max-width: 600px;
            margin: auto;
        }
        #header {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }
        #chat {
            border: 1px solid #ccc;
            height: 350px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        .me {
            font-weight: bold;
        }
        .other {
            font-weight: normal;
        }
    </style>
</head>
<body>

<div id="header"></div>
<div id="chat"></div>

<input id="message" placeholder="Type message..." style="width: 80%;" />
<button onclick="send()">Send</button>

<script>
    const params = new URLSearchParams(window.location.search);
    const userId = params.get("userId");
    const username = params.get("username");
    const chatRoomId = params.get("chatRoomId");

    if (!userId || !username || !chatRoomId) {
        alert("Missing userId / username / chatRoomId");
        throw new Error("Missing params");
    }

    // Header
    document.getElementById("header").innerHTML = `
        <b>Connected as:</b> ${username}<br/>
        <b>Private Chat</b>
    `;

    const chatDiv = document.getElementById("chat");

    // ================================
    // LOAD CHAT HISTORY FIRST
    // ================================
    fetch(`/chatrooms/${chatRoomId}/messages`)
        .then(res => res.json())
        .then(messages => {
            messages.forEach(body => {
                const isMe = body.senderId === userId;
                const senderLabel = isMe ? "You" : body.senderUsername;
                const cssClass = isMe ? "me" : "other";

                chatDiv.innerHTML +=
                    `<p class="${cssClass}">${senderLabel}: ${body.content}</p>`;
            });

            chatDiv.scrollTop = chatDiv.scrollHeight;

            // After history is loaded â†’ connect WebSocket
            connectWebSocket();
        })
        .catch(err => {
            console.error("Failed to load chat history", err);
            connectWebSocket(); // still connect even if history fails
        });

    let stompClient;

    // ================================
    // CONNECT WEBSOCKET
    // ================================
    function connectWebSocket() {
        const socket = new WebSocket(
            "ws://localhost:8080/ws?userId=" + userId + "&chatRoomId=" + chatRoomId
        );

        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            console.log(" WebSocket connected");

            stompClient.subscribe("/topic/chatroom/" + chatRoomId, (msg) => {
                const body = JSON.parse(msg.body);

                const isMe = body.senderId === userId;
                const senderLabel = isMe ? "You" : body.senderUsername;
                const cssClass = isMe ? "me" : "other";

                chatDiv.innerHTML +=
                    `<p class="${cssClass}">${senderLabel}: ${body.content}</p>`;

                chatDiv.scrollTop = chatDiv.scrollHeight;
            });
        });
    }

    // ================================
    // SEND MESSAGE
    // ================================
    function send() {
        const input = document.getElementById("message");
        if (!input.value.trim()) return;

        stompClient.send(
            "/app/chat.send",
            {},
            JSON.stringify({ content: input.value })
        );

        input.value = "";
    }
</script>

</body>
</html>
