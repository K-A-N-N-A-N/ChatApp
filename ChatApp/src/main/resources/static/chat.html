<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial;
            max-width: 600px;
            margin: auto;
        }

        #header {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }

        #chat {
            border: 1px solid #ccc;
            height: 350px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            background: #fafafa;
            display: flex;
            flex-direction: column;
        }

        /* Message wrapper */
        .message {
            max-width: 70%;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 10px;
            word-wrap: break-word;
            font-size: 14px;
        }

        /* My messages → right */
        .me {
            align-self: flex-end;
            background-color: #dcf8c6;
            text-align: right;
        }

        /* Other messages → left */
        .other {
            align-self: flex-start;
            background-color: #e5e5ea;
            text-align: left;
        }

        .sender {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 3px;
        }
    </style>
</head>
<body>

<div id="header"></div>
<div id="chat"></div>

<input id="message" placeholder="Type message..." style="width: 80%;" />
<button onclick="send()">Send</button>

<script>
    const params = new URLSearchParams(window.location.search);
    const chatRoomId = params.get("chatRoomId");

    if (!chatRoomId) {
        alert("Missing chatRoomId");
        throw new Error("Missing chatRoomId");
    }

    let currentUserId;
    let currentUsername;
    let stompClient;

    const chatDiv = document.getElementById("chat");

    // ================================
    // FETCH LOGGED-IN USER
    // ================================
    fetch("/auth/me")
        .then(res => res.json())
        .then(user => {
            if (!user.userId || !user.username) {
                alert("User not logged in");
                throw new Error("Not logged in");
            }

            currentUserId = user.userId;
            currentUsername = user.username;

            document.getElementById("header").innerHTML = `
                <b>Connected as:</b> ${currentUsername}<br/>
                <b>Chat Room</b>
            `;

            loadChatHistory();
        });

    // ================================
    // LOAD CHAT HISTORY
    // ================================
    function loadChatHistory() {
        fetch(`/chatrooms/${chatRoomId}/messages`)
            .then(res => res.json())
            .then(messages => {
                messages.forEach(renderMessage);
                chatDiv.scrollTop = chatDiv.scrollHeight;
                connectWebSocket();
            })
            .catch(err => {
                console.error("Failed to load chat history", err);
                connectWebSocket();
            });
    }

    // ================================
    // CONNECT WEBSOCKET
    // ================================
    function connectWebSocket() {
        const socket = new WebSocket(
            "ws://localhost:8080/ws?chatRoomId=" + chatRoomId
        );

        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            stompClient.subscribe("/topic/chatroom/" + chatRoomId, (msg) => {
                renderMessage(JSON.parse(msg.body));
            });
        });
    }

    // ================================
    // RENDER MESSAGE
    // ================================
    function renderMessage(body) {
        const isMe = body.senderId === currentUserId;
        const cssClass = isMe ? "me" : "other";
        const senderLabel = isMe ? "You" : body.senderUsername;

        const messageHtml = `
            <div class="message ${cssClass}">
                <div class="sender">${senderLabel}</div>
                <div>${body.content}</div>
            </div>
        `;

        chatDiv.insertAdjacentHTML("beforeend", messageHtml);
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // ================================
    // SEND MESSAGE
    // ================================
    function send() {
        const input = document.getElementById("message");
        if (!input.value.trim()) return;

        stompClient.send(
            "/app/chat.send",
            {},
            JSON.stringify({ content: input.value })
        );

        input.value = "";
    }
</script>

</body>
</html>
